name: contentgen-agent

on:
  workflow_dispatch:
    inputs:
      commit_msg:
        description: Commit message for the run
        required: false
        default: "chore(agent): auto-run"
        type: string
      no_check:
        description: Skip YAML validation
        required: false
        default: false
        type: boolean
      fix_tabs:
        description: Convert tabs to spaces before YAML parse
        required: false
        default: true
        type: boolean
  push:

permissions:
  contents: write

jobs:
  agent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Ensure runtime deps for agent script
        run: |
          npm i -D yaml fast-glob || true

      - name: Run agent
        env:
          # Optional tokens if you later want deploy steps:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

          # Agent config
          AGENT_REMOTE: origin
          AGENT_BRANCH: ${{ github.ref_name }}
          AGENT_TEST_FILE: .agent_heartbeat

          # Inputs
          NO_CHECK: ${{ github.event_name == 'workflow_dispatch' && inputs.no_check || false }}
          FIX_TABS: ${{ github.event_name == 'workflow_dispatch' && inputs.fix_tabs || true }}
          COMMIT_MSG: ${{ github.event_name == 'workflow_dispatch' && inputs.commit_msg || 'chore(agent): auto-run' }}
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "contentgen-agent"
          git config user.email "actions@users.noreply.github.com"

          # Make sure weâ€™re on the same branch the workflow is running on
          git checkout "${AGENT_BRANCH}" || true

          FLAGS=( --apply
                  --task write-test-change
                  --task yaml-check
                  --task commit-push
                  --commit "${COMMIT_MSG}" )

          # pass optional flags based on inputs
          if [[ "${NO_CHECK}" == "true" ]]; then FLAGS+=( --no-check ); fi
          if [[ "${FIX_TABS}" == "true" ]]; then FLAGS+=( --fix ); fi

          node scripts/agent.mjs "${FLAGS[@]}"

      - name: Upload agent run report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-report
          path: agent_reports/latest.json
          if-no-files-found: warn
